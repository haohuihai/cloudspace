version: 2
jobs:
  build:
    docker:
      - image: cimg/node:16.14
    working_directory: ~/cloudspace
    branches:
      only:
        - master
    machine:  # 以虚拟机的方式运行
      enabled: true
    steps:
      - checkout
      - run: sudo npm install -g npm@6
      - run: npm install
      - save_cache:
          key: v1-dependencies-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run build:pro
      - run: echo '部署开始'
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies
      - add_ssh_keys:
          fingerprints:
            - "06:f4:f6:4a:9d:43:0d:9e:0a:dd:15:33:27:0a:bf:3f"
      - run: sudo apt-get update && sudo apt-get install rsync && sudo apt-get install openssh-client
      - run: pwd
      # - run: echo $REMOTE_HOSTKEY >> /home/circleci/.ssh/known_hosts
      - run: ls
      # - run:
      #     name: Deploy Over SSH
      #     command: ssh root@101.132.124.188 -vvv
          # scp -v /home/knowledge/aaa.ts $SSH_USER@$SSH_IP:/www/wwwroot/testbuild/
      - deploy:
          name: deploy
          command: scp -vr  -o StrictHostKeyChecking=no /home/circleci/cloudspace/dist/* $SSH_USER@$SSH_IP:/www/wwwroot/cloudspace/
          # command: |
          #   ls
          #   pwd
            
          #   if [ "${CIRCLE_BRANCH}" = "main" ]; then
          #     rsync -avce ssh /home/knowledge/aaa.ts $SSH_USER@$SSH_IP:/www/wwwroot/testbuild/
          #   else
          #     echo "Not master branch, dry run only"
          #   fi
      - run: echo '部署完毕啊'
# workflows:
#   version: 2
#   scheduled-workflow:
#     jobs:
#       - build
      # - run:
      #     name: Prepare shell commands
      #     command: chmod +x deploy.sh
      # - run:
      #     name: Run Deploy to Github pages
      #     command: ./deploy.sh